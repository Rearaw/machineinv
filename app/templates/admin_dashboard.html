{% extends "base.html" %}
{% block content %}
<script src="{{ url_for('static', filename='jpdf/jspdf.umd.min.js') }}"></script>
<script src="{{ url_for('static', filename='jpdf/jspdf.plugin.autotable.min.js') }}"></script>

<!-- Tabs -->
<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="machines-tab" data-bs-toggle="tab" data-bs-target="#machines" type="button" role="tab"><i class= 'ion-ios-cog-outline'></i>Total Machines</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab"><i class= 'ion-ios-people-outline'></i>Total Users</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="due-tab" data-bs-toggle="tab" data-bs-target="#due" type="button" role="tab"><i class= 'ion-wrench'></i>Service Due</button>
  </li>
    <li class="nav-item" role="presentation">
    <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync" type="button" role="tab"><i class= 'ion-android-sync'></i>Sync</button>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content mt-3" id="dashboardTabsContent">
  <!-- Machines Tab -->
  <div class="tab-pane fade show active" id="machines" role="tabpanel">
    <a href="{{ url_for('add_equipment') }}" class="btn btn-outline-secondary"><i class='ion-android-add'></i>  Add New Equipment</a>
    <a onclick="generatePDF()" class="btn btn-outline-secondary"><i class="ion-android-document"></i> Download</a><p></p>
    <table class="table table-hover table-bordered" id="table-all_equipments">
      <thead class="table-dark">
        <tr>
          <th>Name</th>
          <th>serial_number</th>
          <th>Category</th>
          <th>Location</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for eq in all_equipments %}
        <tr onclick="window.location='{{ url_for('equipment_details', equipment_id=eq.equipment_id) }}'" style="cursor: pointer;">
          <td>{{ eq.equipment_name }}</td>
          <td>{{ eq.serial_number }}</td>
          <td>{{ eq.category.category_name if eq.category else 'N/A' }}</td>
          <td>{{ eq.location.location_name if eq.location else 'N/A' }}</td>
          <td>{{ eq.status }}</td>
          <td>
            <form method="post" action="{{ url_for('delete_equipment', equipment_id=eq.equipment_id) }}" onsubmit="return confirm('Are you sure?')">
              <button type="submit" class="btn btn-sm btn-danger">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>

  <!-- Users Tab -->
  <div class="tab-pane fade" id="users" role="tabpanel">
    <a href="{{ url_for('add_user') }}" class="btn btn-outline-secondary"><i class='ion-android-add'></i>  Add New User</a><p></p>
    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Username</th>
          <th>Role</th>
        </tr>
      </thead>
      <tbody>
        {% for user in all_users %}
        <tr>
          <td>{{ user.username }}</td>
          <td>{{ user.role.role_name if user.role else 'N/A' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Due Services Tab -->
  <div class="tab-pane fade" id="due" role="tabpanel">
    <ul class="list-group">
      {% if overdue_equipments %}
        {% for eq in overdue_equipments %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ eq.equipment_name }}</strong>
            <small class="text-muted">({{ eq.location.location_name if eq.location else 'N/A' }})</small><br>
            <span class="text-danger">
              Due: {{ eq.services[-1].service_next_date.strftime('%Y-%m-%d') if eq.services else 'Unknown' }}
            </span>
          </div>
          <a href="{{ url_for('equipment_details', equipment_id=eq.equipment_id) }}" class="btn btn-sm btn-outline-warning">View</a>
        </li>
        {% endfor %}
      {% else %}
        <li class="list-group-item text-muted">No machines are due for service.</li>
      {% endif %}
    </ul>
  </div>
  <!-- sync tab-->
<div class="tab-pane fade" id="sync" role="tabpanel">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Status Display -->
    <div id="status-section" class="alert alert-info">
        <h2>Device Location: <strong id="server_ip">{{server_ip }}</strong></h2>
        <div id="connection-status">
            {% if sync_status.status == 'connected' %}
                <span class="badge bg-success">Connected</span>
                <small class="ms-2">to {{ sync_status.peer_ip }}</small>
            {% elif sync_status.status == 'connecting' %}
                <span class="badge bg-warning">Connecting...</span>
            {% else %}
                <span class="badge bg-secondary">Disconnected</span>
            {% endif %}
        </div>
        <div id="session-info" class="mt-1">
            <small>Session: {{ sync_status.session_id }}</small>
        </div>
    </div>
<!-- Data Display Section -->
<div id="data-section" class="mt-4">
    <!-- Comparison Results -->
    <div id="comparison-section" class="mb-4" 
         {% if not sync_status.get('comparison_results') %}style="display:none;"{% endif %}>
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">üìä File Comparison Results</h5>
            </div>
            <div class="card-body">
                {% if sync_status.get('comparison_results') %}
                    {% set comp = sync_status.comparison_results %}
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h4>{{ comp.summary.unchanged }}</h4>
                                    <small>Unchanged</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h4>{{ comp.summary.modified }}</h4>
                                    <small>Modified</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body">
                                    <h4>{{ comp.summary.removed }}</h4>
                                    <small>Removed</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h4>{{ comp.summary.added }}</h4>
                                    <small>Added</small>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted">No comparison data available yet</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Local Data -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üì± This Device</h5>
                    <small>{{ sync_status.local_data.device_info.device_id if sync_status.local_data }}</small>
                </div>
                <div class="card-body">
                    {% if sync_status.local_data %}
                        <div class="mb-3">
                            <strong>Files:</strong> {{ sync_status.local_data.system_info.total_files }}<br>
                            <strong>Snapshot:</strong> {{ sync_status.local_data.system_info.snapshot_time }}<br>
                            <strong>IP:</strong> {{ sync_status.local_data.device_info.ip_address }}
                        </div>
                        <details>
                            <summary>Show File Details</summary>
                            <pre class="mt-2 small"><code>{{ sync_status.local_data.file_snapshot | tojson(indent=2) }}</code></pre>
                        </details>
                    {% else %}
                        <p class="text-muted">No local data available</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Peer Data -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üñ•Ô∏è Connected Device</h5>
                    <small>{{ sync_status.peer_data.device_info.device_id if sync_status.peer_data }}</small>
                </div>
                <div class="card-body">
                    {% if sync_status.peer_data %}
                        <div class="mb-3">
                            <strong>Files:</strong> {{ sync_status.peer_data.system_info.total_files }}<br>
                            <strong>Snapshot:</strong> {{ sync_status.peer_data.system_info.snapshot_time }}<br>
                            <strong>IP:</strong> {{ sync_status.peer_data.device_info.ip_address }}<br>
                            <strong>Received:</strong> {{ sync_status.peer_data.received_at }}
                        </div>
                        <details>
                            <summary>Show File Details</summary>
                            <pre class="mt-2 small"><code>{{ sync_status.peer_data.file_snapshot | tojson(indent=2) }}</code></pre>
                        </details>
                    {% else %}
                        <p class="text-muted">No data received from peer yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- QR display -->
    <div id="qr-section" {% if sync_status.status != 'disconnected' %}style="display:none;"{% endif %}>
        <h4>Scan this QR:</h4>
        <div id="qrcode"></div>
        <button class="btn btn-outline-primary mt-3" onclick="startScanner()">Scan Another Server</button>
    </div>

     <!-- Scanner -->
    <div id="scanner-section" style="display:none;">
        <h4>Scan Server QR</h4>
        <div id="reader" style="width:300px; margin:auto;"></div>
        <div id="scan-result" class="mt-2 text-success"></div>
        <button class="btn btn-outline-danger mt-3" onclick="stopScanner()">Cancel</button>
    </div>

    <!-- Loading / waiting -->
    <div id="waiting-section" style="display:none; text-align:center;">
        <h4>‚è≥ Waiting for connection...</h4>
        <p>Please wait while we attempt to pair.</p>
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2">
            <button class="btn btn-outline-secondary" onclick="cancelConnection()">Cancel</button>
        </div>
    </div>

    <hr>
    <h4>Manual Entry</h4>
    <input type="text" id="manual-code" placeholder="Enter server code (IP:port)" class="form-control" />
    <button onclick="connectManual()" class="btn btn-primary mt-2">Connect</button>
    
    <!-- Action Buttons -->
    <div class="mt-4">
        <button onclick="resetConnection()" class="btn btn-outline-warning">Reset Connection</button>
        <button onclick="refreshData()" class="btn btn-outline-info ms-2">Refresh Data</button>
    </div>
</div>

<script>
let html5QrcodeScanner = null;
let statusCheckInterval = null;

// Initialize QR code for this device
document.addEventListener('DOMContentLoaded', function() {
    // Generate QR code for current device
    //const currentUrl = window.location.origin;
    const currentUrl=document.getElementById("server_ip").innerText + ":5000";

    new QRCode(document.getElementById("qrcode"), {
        text: currentUrl,
        width: 200,
        height: 200,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });
    
    // Start checking status
    checkStatus();
    statusCheckInterval = setInterval(checkStatus, 2000);
});

// Check connection status
async function checkStatus() {
    try {
        const response = await fetch('/get_status');
        const data = await response.json();
        
        updateUI(data);
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

// Update UI based on status
function updateUI(statusData) {
    const serverIpDisplay = document.getElementById('server_ip');
    const statusElement = document.getElementById('connection-status');
    const qrSection = document.getElementById('qr-section');
    const waitingSection = document.getElementById('waiting-section');
    const dataSection = document.getElementById('data-section');
    const comparisonSection = document.getElementById('comparison-section');
    
    serverIpDisplay.textContent = statusData.server_ip || '{{ server_ip }}';
    
    switch(statusData.status) {
        case 'disconnected':
            statusElement.innerHTML = '<span class="badge bg-secondary">Disconnected</span>';
            qrSection.style.display = 'block';
            waitingSection.style.display = 'none';
            dataSection.style.display = 'none';
            comparisonSection.style.display = 'none';
            break;
        case 'connecting':
            statusElement.innerHTML = '<span class="badge bg-warning">Connecting...</span>';
            qrSection.style.display = 'none';
            waitingSection.style.display = 'block';
            dataSection.style.display = 'none';
            comparisonSection.style.display = 'none';
            break;
        case 'connected':
            statusElement.innerHTML = `<span class="badge bg-success">Connected</span><small class="ms-2">to ${statusData.peer_ip}</small>`;
            qrSection.style.display = 'none';
            waitingSection.style.display = 'none';
            dataSection.style.display = 'block';
            
            // Show comparison section if we have comparison results
            if (statusData.comparison_results) {
                comparisonSection.style.display = 'block';
            }
            break;
        case 'failed':
            statusElement.innerHTML = '<span class="badge bg-danger">Connection Failed</span>';
            qrSection.style.display = 'block';
            waitingSection.style.display = 'none';
            dataSection.style.display = 'none';
            comparisonSection.style.display = 'none';
            alert('Connection failed. Please check the IP address and try again.');
            break;
    }
}

// Manual connection
async function connectManual() {
    const manualCode = document.getElementById('manual-code').value.trim();
    if (!manualCode) {
        alert('Please enter a server address (IP:port)');
        return;
    }
    
    await processConnection(manualCode);
}

// Process connection
async function processConnection(serverAddress) {
    try {
        // Show waiting section
        document.getElementById('qr-section').style.display = 'none';
        document.getElementById('scanner-section').style.display = 'none';
        document.getElementById('waiting-section').style.display = 'block';
        
        // Send connection request to server
        const response = await fetch('/update_connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                peer_server_ip: serverAddress
                
            })
        });
        
        const result = await response.json();
        console.log('Connection initiated:', result);
        
    } catch (error) {
        console.error('Error initiating connection:', error);
        alert('Error initiating connection: ' + error.message);
        resetUI();
    }
}

// Refresh data
function refreshData() {
    checkStatus();
}

// QR Scanner functions
function startScanner() {
    document.getElementById('qr-section').style.display = 'none';
    document.getElementById('scanner-section').style.display = 'block';
    
    html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", 
        { 
            fps: 10, 
            qrbox: { width: 250, height: 250 } 
        },
        /* verbose= */ false
    );
    
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
}

function stopScanner() {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear().catch(error => {
            console.error("Failed to clear html5QrcodeScanner. ", error);
        });
    }
    document.getElementById('qr-section').style.display = 'block';
    document.getElementById('scanner-section').style.display = 'none';
}

function onScanSuccess(decodedText, decodedResult) {
    console.log(`Scan result: ${decodedText}`, decodedResult);
    
    document.getElementById('scan-result').innerHTML = 
        `<strong>Scanned:</strong> ${decodedText}`;
    
    // Process the scanned QR code
    processConnection(decodedText);
    
    // Stop scanner after successful scan
    stopScanner();
}

function onScanFailure(error) {
    // This is expected, no need to handle every failure
}

// Cancel connection
function cancelConnection() {
    resetUI();
}

// Reset connection
async function resetConnection() {
    try {
        await fetch('/reset_connection');
        resetUI();
    } catch (error) {
        console.error('Error resetting connection:', error);
    }
}

// Reset UI to initial state
function resetUI() {
    document.getElementById('qr-section').style.display = 'block';
    document.getElementById('scanner-section').style.display = 'none';
    document.getElementById('waiting-section').style.display = 'none';
    document.getElementById('manual-code').value = '';
    document.getElementById('scan-result').innerHTML = '';
    
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear().catch(error => {
            console.error("Failed to clear html5QrcodeScanner. ", error);
        });
    }
}

// Cleanup when leaving the page
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        clearInterval(statusCheckInterval);
    }
});
</script>
</div>
<script>

  function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(18);
      doc.setTextColor(40, 40, 40);
      doc.text(`All Equipments Report`, 105, 15, { align: 'center' });
      
      // Add date
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 25);
      
      // Get table data
      const table = document.getElementById(`table-all_equipments`);
      let tableData = [];
      
      if (table) {
          // Process table rows
          const rows = table.querySelectorAll('tbody tr');
          rows.forEach(row => {
              const rowData = [];
              const cells = row.querySelectorAll('td');
              cells.forEach((cell, index) => {
                  // Skip the actions column (last column)
                  if (index < cells.length - 1) {
                      rowData.push(cell.textContent.trim());
                  }
              });
              tableData.push(rowData);
          });
          
          // Add table to PDF
          doc.autoTable({
              startY: 30,
              head: [['Machine Name','Serial Number','category','Location', 'Status']],
              body: tableData,
              theme: 'grid',
              headStyles: {
                  fillColor: [41, 128, 185],
                  textColor: 255,
                  fontSize: 10
              },
              bodyStyles: {
                  fontSize: 9
              },
              margin: { top: 30 }
          });
      } else {
          // No machines case
          doc.setFontSize(12);
          doc.text('No machines found.', 14, 40);
      }
      
      // Add footer
      const pageCount = doc.internal.getNumberOfPages();
      for(let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(150);
          doc.text(`Page ${i} of ${pageCount}`, 195, 285, { align: 'right' });
      }
      
      // Save the PDF
      doc.save(`All_Machines_Report.pdf`);
  }
  </script>

  
{% endblock %}
